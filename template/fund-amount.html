<!DOCTYPE html>
<html>
  <head>
    <title>éŸ­èœç›’å­</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link
      href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.9.2/theme-chalk/index.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="vendors/toastify.css" />
    <style>
      body,
      html {
        height: 100%;
        -webkit-tap-highlight-color: transparent;
      }

      div {
        margin-left: 20px;
        line-height: 28px;
      }
      .list .name,
      .amount {
        display: inline-block;
      }
      .unit {
        float: right;
      }
      .amount {
        float: right;
        width: 220px !important;
      }
      .name {
        font-size: 14px;
      }
      .item {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }
      .el-input {
        width: 160px;
        height: 28px;
      }
      .el-input__inner {
        height: 28px;
        width: 120px;
        background-color: #eee;
      }
      .main {
        margin: 0 auto;
        width: 980px;
        padding: 32px;
      }
      .footer {
        width: 560px;
        margin: 30px auto 10px auto;
        text-align: center;
      }
      .footer .info {
        font-size: 16px;
        margin-top: 20px;
        color: #696666;
      }
      .operate {
        font-size: 12px;
      }
      .unitDiv {
        width: 224px;
        float: right;
      }
      .unitPriceInput {
        width: 100px;
      }
      .sharesInput {
        width: 100px;
      }
      .input-row {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .input-group {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .red {
        color: #f56c6c;
      }
      .green {
        color: green;
      }
      .html2canvas-container {
        position: fixed;
        left: -2000;
        top: 1000;
        margin-top: 200px;
        background-color: #303133;
      }
      .imgHACK {
        display: none;
      }

      .main-canvas {
        width: 1000px;
        background-color: #303133;
      }
      .qr {
        margin: 10px auto;
        width: 120px;
      }
    </style>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-M5021C8VSH"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-M5021C8VSH');
    </script>
  </head>

  <body ontouchstart>
    <button
      class="el-button el-button--info el-button--mini"
      id="refresh"
      style="
        position: fixed;
        right: 8px;
        top: 20px;
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 3px;
      "
    >
      åˆ·æ–°
    </button>
    <button
      class="el-button el-button--info el-button--mini"
      id="sort"
      style="
        position: fixed;
        right: 8px;
        top: 60px;
        padding: 4px 8px;
        font-size: 10px;
        border-radius: 3px;
      "
    >
      æ”¶ç›Šç‡â†“
    </button>
    <div class="main">
      <h2 style="text-align: center; color: #409eff">
        æŒä»“é‡‘é¢ <span id="totalMoney"></span>
      </h2>

      <p style="font-size: 12px; color: #696666; text-align: center">
        å¡«å†™æŒä»“ä»½é¢å’Œæˆæœ¬ä»·ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—æŒä»“é‡‘é¢ã€‚æŒä»“é‡‘é¢ = ä»½é¢ Ã— åŸºé‡‘å‡€å€¼ï¼Œä»½é¢ä¿ç•™ä¸¤ä½å°æ•°
      </p>
      <div class="list"></div>
      <div class="footer">
        <button
          class="el-button el-button--primary el-button--medium rm"
          id="save"
        >
          ä¿å­˜
        </button>
        <div class="info"></div>
        <div class="operate rm">
          <span style="color: #50ba99; cursor: pointer" class="text2image"
            >æŒä»“å›¾ç‰‡åˆ†äº«</span
          >&nbsp;&nbsp;&nbsp;&nbsp;<span
            style="color: #50ba99; cursor: pointer"
            class="text2image"
            data-type="shouyi"
            >æ”¶ç›Šå›¾ç‰‡åˆ†äº«</span
          >
        </div>
      </div>
    </div>
    <canvas id="paint" width="1000" height="600" style="display: none"></canvas>
    <div class="html2canvas-container">
      <div
        class="main-canvas"
        style="width: 1000px; height: auto; background-color: #303133"
      ></div>
    </div>
    <div class="qr" style="display: none">
      <div class="imgHACK">
        <img src="images/qrcode_black.png" alt="" />
      </div>
    </div>

    <script src="https://cdn.staticfile.org/jquery/2.0.0/jquery.min.js"></script>
    <script src="vendors/html2canvas.min.js"></script>
    <script src="vendors/toastify.js"></script>
    <script src="vendors/canvas-text.js"></script>
    <script>
      const vscode = acquireVsCodeApi();
      const deviceId =
        Math.random().toString(16).substr(2) +
        Math.random().toString(32).substr(2);

      let sortType = 'default';
      const list = $('.list');
      let fundList = [];
      let priceDate = new Date().toDateString();
      window.addEventListener('message', (event) => {
        const msg = event.data;

        switch (msg.command) {
          case 'init':
            sortType = msg.sortType || 'default';
            dateStr = msg.dateStr; // æ‡’å¾—å†å†™æ ¼å¼åŒ–æ—¥æœŸ
            init(msg.data);
            Toastify({
              text: 'æ•°æ®å·²åˆ·æ–°ï¼',
              duration: 1000,
            }).showToast();
            break;
        }
      });

      function init(data) {
        // const fundList = ${JSON.stringify(list)};
        if (sortType !== 'default') {
          fundList = data.sort((a, b) => {
            const ae = a.earningPercent || 0;
            const be = b.earningPercent || 0;
            return sortType === 'earningsDesc' ? be - ae : ae - be;
          });
        } else {
          fundList = data;
        }
        // console.log(fundList);
        
        init2()
      }

      function init2() {
        let listStr = '';
        let totalMoney = 0;
        let totalEarnings = 0;
        fundList.forEach((item, index) => {
          const amount = item.amount || 0;
          const unitPrice = item.unitPrice || 0;
          const earningPercent = item.earningPercent || 0;
          if (index === 0) {
            priceDate = item.priceDate;
          }
          if (!priceDate) {
            priceDate = item.priceDate;
          }
          // æŒä»“é‡‘é¢ = åŸºé‡‘å‡€å€¼ * æŒæœ‰ä»½é¢
          const calculatedAmount = (item.shares && item.price) ? (item.shares * item.price).toFixed(2) : amount.toFixed(2);
          const str = `
            <div class="item">
              <div class="name" data-code="${item.code}">
                ${item.name}
                ï¼ˆ<span class="calculated-amount-text">${calculatedAmount}å…ƒ</span> | <i class="${earningPercent > 0 ? 'red' : 'green'}">${earningPercent}%</i>ï¼‰
              </div>
              <div class="input-row">
                <div class="input-group">
                  æŒä»“æˆæœ¬ä»·ï¼š<input type="number" class="unitPriceInput el-input__inner" id="${item.code}_unit" value="${unitPrice}" /> <span class="unit">å…ƒ</span>
                </div>
                <div class="input-group">
                  æŒä»“ä»½é¢ï¼š<input type="number" step="0.01" class="sharesInput el-input__inner" id="${item.code}_shares" value="${parseFloat((item.shares ?? 0).toFixed(2)) || ''}" /> <span class="unit">ä»½</span>
                </div>
              </div>
            </div>
          `;

          listStr += str;
          const earnings = item.earnings || 0;

          totalMoney += amount;
          totalEarnings += earnings;
        });
        list.html(listStr);
        $('#totalMoney').html(totalMoney.toFixed(2));
        // $('#priceDate').html(priceDate || '');
        // æ”¶ç›Šç»Ÿè®¡
        if (totalEarnings !== 0) {
          const color = totalEarnings > 0 ? '#f55151' : 'green';
          let str =
            priceDate +
            ' ä¼°ç®—æ”¶ç›Šä¸ºï¼š <span style="font-size:20px;color:' +
            color +
            '">' +
            totalEarnings.toFixed(2) +
            '</span> å…ƒï¼Œ' +
            (totalEarnings > 0
              ? 'ç»§ç»­åŠ æ²¹ğŸ’ªï¼'
              : 'åœ¨Aè‚¡ï¼Œå®ˆä½æ‰ä¼šæœ‰æ”¶ç›Šï¼ŒåŠ æ²¹ğŸ’ª');
          if (totalEarnings >= 666) {
            str +=
              '<span class="rm">&nbsp;æ­å–œåƒè‚‰ï¼Œè€æ¿ <span style="color:#409EFF;cursor:pointer" id="donate">ğŸ’°æ‰“èµ</span> ä¸€ä¸‹ï¼</span>';
          }

          $('.footer .info').html(str);

          $('#donate').click(function () {
            vscode.postMessage({
              command: 'donate',
              text: 'æ‰“èµ',
            });
          });

          $('.text2image').click((evt) => {
            const type = evt.target.getAttribute('data-type') || 'all';
            vscode.postMessage({
              command: 'telemetry',
              type,
            });

            let selector = type === 'shouyi' ? '.footer' : '.main';

            $('.main-canvas').html($(selector).html());
            const canvasEl = $('.main-canvas');
            canvasEl.find('.rm').hide();
            canvasEl.find('.qr').show();
            canvasEl
              .find('.amount')
              .map((i, el) => (el.innerText = 'æŒä»“é‡‘é¢ï¼š*** å…ƒ'));
            canvasEl.find('#totalMoney').html('*** å…ƒ');

            const targetDom = canvasEl[0];
            const paintCanvas = document.getElementById('paint');
            const paintCtx = paintCanvas.getContext('2d');
            const scale = 2;
            const qrImageWidth = 240;
            const qrImageHeight = 310;
            // è‡ªå®šä¹‰ç»˜åˆ¶
            if (type === 'shouyi') {
              paintCanvas.height = qrImageHeight / 2;
              paintCanvas.width = qrImageWidth * scale;
              paintCtx.fillStyle = '#303133';
              paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);

              const earnningTxt = totalEarnings.toFixed(2);
              const title = 'ä»Šæ—¥æ”¶ç›Š';
              paintCtx.fillStyle = '#409eff';
              canvasTxt.fontSize = 20;
              canvasTxt.lineHeight = 20;
              canvasTxt.align = 'left';
              canvasTxt.drawText(paintCtx, title, 100, 10, 120, 40);
              canvasTxt.drawText(
                paintCtx,
                Number(earnningTxt) < 0 ? 'ğŸœ' : 'ğŸ—',
                184,
                10,
                120,
                40
              );
              paintCtx.fillStyle =
                Number(earnningTxt) < 0 ? 'green' : '#f55151';
              canvasTxt.fontSize = Number(earnningTxt) > 10000 ? 30 : 40;
              // canvasTxt.lineHeight = 20;
              canvasTxt.drawText(
                paintCtx,
                earnningTxt + 'å…ƒ',
                100,
                50,
                200,
                80
              );
              canvasTxt.fontSize = 10;
              paintCtx.fillStyle = 'gray';
              canvasTxt.drawText(paintCtx, priceDate, 100, 120, 100, 40);

              paintCtx.drawImage(
                $('.imgHACK>img')[0],
                paintCanvas.width - qrImageWidth / 2,
                0,
                qrImageWidth / 2,
                qrImageHeight / 2
              );
              return copyImageToClipboard(paintCanvas);
            }
            // htmlæˆªå›¾
            html2canvas(targetDom, {
              dpi: window.devicePixelRatio * 3,
              scale,
              height: targetDom.offsetHeight,
              width: targetDom.offsetWidth,
              scrollY: 0, // è§£å†³åç§»é—®é¢˜
            }).then((htmlcanvas) => {
              paintCanvas.height =
                targetDom.offsetHeight * scale + qrImageHeight;
              paintCanvas.width = targetDom.offsetWidth * scale;
              paintCtx.fillStyle = '#303133';
              paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
              paintCtx.drawImage(
                htmlcanvas,
                0,
                10,
                htmlcanvas.width,
                htmlcanvas.height
              );
              const imageOffsetWidth = paintCanvas.width / 2 - qrImageWidth / 2;
              const imageOffsetHeight = paintCanvas.height - qrImageHeight + 8;
              paintCtx.drawImage(
                $('.imgHACK>img')[0],
                imageOffsetWidth,
                imageOffsetHeight,
                qrImageWidth,
                qrImageHeight
              );
              canvasTxt.fontSize = 20;
              paintCtx.fillStyle = 'gray';
              canvasTxt.drawText(
                paintCtx,
                priceDate,
                imageOffsetWidth - 200,
                imageOffsetHeight + 100,
                150,
                80
              );

              copyImageToClipboard(paintCanvas);
              /*  if (document.body.querySelector('canvas')) {
                document.body.querySelector('canvas').remove();
                document.body.appendChild(paintCanvas);
              } */
            });
          });
        }
      }

      function copyImageToClipboard(canvas) {
        const base64Data = canvas
          .toDataURL('image/png')
          .replace('data:image/png;base64,', '');
        if (base64Data && base64Data.length < 100) {
          Toastify({
            text: 'ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼',
            duration: 2000,
            backgroundColor: '#f56c6c',
            gravity: 'bottom',
          }).showToast();
          return;
        }
        const blobInput = convertBase64ToBlob(base64Data, 'image/png');
        const clipboardItemInput = new ClipboardItem({
          'image/png': blobInput,
        });
        navigator.clipboard.write([clipboardItemInput]);
        Toastify({
          text: 'å¤åˆ¶å›¾ç‰‡æˆåŠŸï¼Œå¯ä»¥å»ç²˜è´´å‘é€åˆ†äº«äº†ï¼',
          duration: 2500,
          backgroundColor: 'linear-gradient(to right, #00b09b, #96c93d)',
          gravity: 'bottom',
        }).showToast();
      }

      $(function () {
        $('.unitPriceInput,.sharesInput').on('input', function (e) {
          const value = e.target.value;
          if (value.length > 12) {
            e.target.value = value.slice(0, 12);
          }
          
          // å®æ—¶è®¡ç®—æŒä»“é‡‘é¢
          const codeMatch = e.target.id.match(/^(.+)_(unit|shares)$/);
          if (codeMatch) {
            const code = codeMatch[1];
            updateCalculatedAmount(code);
          }
        });
        
        // ä»½é¢è¾“å…¥æ¡†å¤±ç„¦æ—¶æ ¼å¼åŒ–ä¸ºä¸¤ä½å°æ•°
        $('.sharesInput').on('blur', function (e) {
          const value = parseFloat(e.target.value);
          if (!isNaN(value)) {
            e.target.value = value.toFixed(2);
            // é‡æ–°è§¦å‘è®¡ç®—
            const codeMatch = e.target.id.match(/^(.+)_shares$/);
            if (codeMatch) {
              const code = codeMatch[1];
              updateCalculatedAmount(code);
            }
          }
        });
        
        // å®æ—¶è®¡ç®—æŒä»“é‡‘é¢çš„å‡½æ•°
        function updateCalculatedAmount(code) {
          const sharesInput = $('#' + code + '_shares');
          const nameDisplay = $('[data-code="' + code + '"] .calculated-amount-text');
          
          // ä»fundListä¸­æ‰¾åˆ°å¯¹åº”çš„åŸºé‡‘å‡€å€¼
          const fundItem = fundList.find(item => item.code === code);
          const shares = parseFloat(parseFloat(sharesInput.val()).toFixed(2)) || 0; // ä»½é¢ä¿ç•™ä¸¤ä½å°æ•°
          const netValue = fundItem ? fundItem.price : 0; // ä½¿ç”¨åŸºé‡‘å‡€å€¼
          
          // æŒä»“é‡‘é¢ = åŸºé‡‘å‡€å€¼ * æŒæœ‰ä»½é¢
          const calculatedAmount = shares && netValue ? (shares * netValue).toFixed(2) : '0.00';
          
          // æ›´æ–°åç§°ä¸­çš„é‡‘é¢æ˜¾ç¤º
          nameDisplay.text(calculatedAmount + 'å…ƒ');
          
          // é‡æ–°è®¡ç®—æ€»é‡‘é¢
          updateTotalMoney();
        }
        
        // æ›´æ–°æ€»é‡‘é¢
        function updateTotalMoney() {
          let totalMoney = 0;
          $('.calculated-amount-text').each(function() {
            const text = $(this).text().replace('å…ƒ', '');
            const amount = parseFloat(text) || 0;
            totalMoney += amount;
          });
          $('#totalMoney').html(totalMoney.toFixed(2));
        }
        $('#save').click(() => {
          // const ammountObj = {};
          let totalMoney = 0;
          fundList.forEach((item) => {
            let unitPrice = $('#' + item.code + '_unit').val();
            let shares = $('#' + item.code + '_shares').val();
            
            unitPrice = isNaN(Number(unitPrice)) ? 0 : Number(unitPrice);
            shares = isNaN(Number(shares)) || shares === '' ? null : parseFloat(Number(shares).toFixed(2));
            
            // ä½¿ç”¨ä»½é¢å’ŒåŸºé‡‘å‡€å€¼è®¡ç®—æŒä»“é‡‘é¢
            const amount = shares && item.price ? shares * item.price : 0;
            
            item.amount = amount; // æŒä»“é‡‘é¢ï¼ˆè®¡ç®—å¾—å‡ºï¼‰
            item.unitPrice = unitPrice; // æˆæœ¬ä»·
            item.shares = shares; // æŒä»“ä»½é¢
            totalMoney += amount; // æŒä»“é‡‘é¢
            // æ”¶ç›Šç‡
            if (unitPrice !== 0) {
              profitPercent = (item.price - unitPrice) / unitPrice * 100;
              item.earningPercent = profitPercent.toFixed(2);
            } else {
              item.earningPercent = 0;
            }

            // if (typeof ammountObj[item.code] !== 'object') {
            //   ammountObj[item.code] = {};
            // }
            // ammountObj[item.code].amount = amount;
            // ammountObj[item.code].unitPrice = unitPrice;
            // const earnings = item.earnings || 0;
            // ammountObj[item.code].earnings = earnings;
          });
          $('#totalMoney').html(totalMoney.toFixed(2));
          init2()
          vscode.postMessage({
            command: 'success',
            text: JSON.stringify(fundList),
          });
          return

          fetchInfo(fundList, ({ Expansion = {}, Datas = [] }) => {
            const dates = [
              Expansion?.FSRQ?.substr?.(5, 5),
              Expansion?.GZTIME?.substr?.(5, 5),
            ];
            const result = [];
            totalMoney = 0;
            Datas.forEach((item) => {
              const amount = ammountObj[item.FCODE].amount;
              const unitPrice = ammountObj[item.FCODE].unitPrice;
              const obj = {
                code: item.FCODE,
                name: item.SHORTNAME,
                unitPrice: unitPrice, // æˆæœ¬ä»·
                amount: amount, // æŒä»“é‡‘é¢
                earnings: ammountObj[item.FCODE].earnings,
                price: item.NAV, // å‡€å€¼
                priceDate: item.PDATE, // å‡€å€¼æ—¶é—´
                isUpdated: item.PDATE.substr(5, 5) === item.GZTIME.substr(5, 5),
              };
              totalMoney += amount;
              result.push(obj);
            });
            $('#totalMoney').html(totalMoney.toFixed(2));
            // å’Œ vscode webview é€šä¿¡
            vscode.postMessage({
              command: 'success',
              text: JSON.stringify(result),
            });
          });
        });

        $('#refresh').click(() => {
          vscode.postMessage({
            command: 'refresh',
            sortType,
          });
        });
        $('#sort').click(() => {
          sortType =
            sortType === 'earningsDesc' ? 'earningsAsc' : 'earningsDesc';
          vscode.postMessage({
            command: 'refresh',
            sortType,
          });
        });
      });

      function fetchInfo(fundList, cb) {
        const params = {
          pageIndex: 1,
          pageSize: fundList.length,
          plat: 'Android',
          appType: 'ttjj',
          product: 'EFund',
          Version: 1,
          deviceid: deviceId,
          Fcodes: fundList
            .reduce((arr, item) => [...arr, item.code], [])
            .join(','),
        };
        if (!params.deviceid || !params.Fcodes) return;

        const paramsArr = [];
        for (let key in params) {
          if (key && params[key]) {
            paramsArr.push(key + '=' + params[key]);
          }
        }

        window
          .fetch(
            'https://fundmobapi.eastmoney.com/FundMNewApi/FundMNFInfo?' +
              paramsArr.join('&')
          )
          .then((res) => {
            if (res.status !== 200) {
              // console.log('è·å–æ•°æ®å¤±è´¥');
              vscode.postMessage({
                command: 'alert',
                text: 'è·å–æ•°æ®å¤±è´¥',
              });
              return;
            }
            res.json().then(function (d) {
              cb(d);
            });
          });
      }

      function convertBase64ToBlob(base64, type) {
        var bytes = window.atob(base64);
        var ab = new ArrayBuffer(bytes.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < bytes.length; i++) {
          ia[i] = bytes.charCodeAt(i);
        }
        return new Blob([ab], { type: type });
      }

      vscode.postMessage({
        command: 'refresh',
      });
    </script>

    <script></script>
  </body>
</html>
